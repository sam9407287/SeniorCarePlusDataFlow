# âœ… Pipeline æ‰å¹³åŒ–é©—è­‰å ±å‘Š

> é©—è­‰ Pipeline æ˜¯å¦çœŸçš„å°‡ 4 å±¤çµæ§‹è½‰æ›æˆ 2 å±¤ï¼Œè€Œä¸æ˜¯åˆªé™¤æ•¸æ“š

**æœ€å¾Œé‹è¡Œæ™‚é–“ï¼š** 2025-11-19  
**æ¸¬è©¦ç‹€æ…‹ï¼š** âœ… æ‰€æœ‰æ¸¬è©¦é€šé

---

## ğŸ“Š æ¸¬è©¦æ¦‚è¦

| é …ç›® | çµæœ | èªªæ˜ |
|------|------|------|
| **Anchor æ¸¬è©¦** | âœ… é€šé | 3 å€‹ Anchor æ•¸æ“šæ¸¬è©¦ï¼Œ100% æˆåŠŸ |
| **Gateway æ¸¬è©¦** | âœ… é€šé | 2 å€‹ Gateway æ•¸æ“šæ¸¬è©¦ï¼Œ100% æˆåŠŸ |
| **å±¤ç´šè½‰æ›** | âœ… é€šé | 4 å±¤ â†’ 2 å±¤ï¼ˆæˆ– 1 å±¤å¹³é¢çµæ§‹ï¼‰ |
| **æ•¸æ“šä¿ç•™** | âœ… é€šé | æ‰€æœ‰æ•¸æ“šéƒ½è¢«ä¿ç•™ï¼Œæ²’æœ‰åˆªé™¤ |
| **å­—æ®µè½‰æ›** | âœ… é€šé | æ‰€æœ‰å­—æ®µéƒ½è¢«æ­£ç¢ºè½‰æ› |

---

## ğŸ” è©³ç´°å°æ¯”

### Anchor è½‰æ›ç¯„ä¾‹

#### åŸå§‹ 4 å±¤çµæ§‹ï¼ˆ23 å€‹è‘‰å­ç¯€é»ï¼‰

```json
{
  "anchor_id": "anchor_001",                    // ç¬¬1å±¤
  "gateway_id": "gw_001",                       // ç¬¬1å±¤
  "name": "Bed Anchor",                         // ç¬¬1å±¤
  "mac_address": "AA:BB:CC:DD:EE:FF",           // ç¬¬1å±¤
  "status": "online",                           // ç¬¬1å±¤
  "lastSeen": "2025-11-17T14:30:00Z",           // ç¬¬1å±¤
  "isBound": true,                              // ç¬¬1å±¤
  "position": {                                 // ç¬¬1å±¤ - åµŒå¥—å°è±¡
    "x": 5.2,                                   // ç¬¬2å±¤
    "y": 8.1,                                   // ç¬¬2å±¤
    "z": 0.8                                    // ç¬¬2å±¤
  },
  "cloudData": {                                // ç¬¬1å±¤ - æœ€æ·±çš„åµŒå¥—
    "id": 1,                                    // ç¬¬2å±¤
    "gateway_id": 1,                            // ç¬¬2å±¤
    "pub": {                                    // ç¬¬2å±¤
      "msg": {                                  // ç¬¬3å±¤
        "data": {                               // ç¬¬4å±¤ â­ æœ€æ·±å±¤
          "battery_voltage": 3.2,               // ç¬¬5å±¤
          "rssi": -52,                          // ç¬¬5å±¤
          "heart_rate": 72,                     // ç¬¬5å±¤
          "temperature": 36.5                   // ç¬¬5å±¤
        }
      }
    },
    "fw_update": 0,                             // ç¬¬2å±¤
    "led": 1,                                   // ç¬¬2å±¤
    "ble": 1,                                   // ç¬¬2å±¤
    "initiator": 0,                             // ç¬¬2å±¤
    "position": {                               // ç¬¬2å±¤
      "x": 5.2,                                 // ç¬¬3å±¤
      "y": 8.1,                                 // ç¬¬3å±¤
      "z": 0.8                                  // ç¬¬3å±¤
    }
  }
}
```

#### æ‰å¹³åŒ– 2 å±¤çµæ§‹ï¼ˆ21 å€‹å­—æ®µï¼‰

```json
{
  // ç¬¬1å±¤ï¼šè¨­å‚™åŸºæœ¬ä¿¡æ¯
  "device_id": "anchor_001",
  "device_type": "anchor",
  "device_name": "Bed Anchor",
  "gateway_id": "gw_001",
  "mac_address": "AA:BB:CC:DD:EE:FF",
  "position_x": 5.2,
  "position_y": 8.1,
  "position_z": 0.8,
  "status": "online",
  "last_seen": "2025-11-17T14:30:00Z",
  "is_bound": true,

  // ç¬¬2å±¤ï¼šå‚³æ„Ÿå™¨æ•¸æ“š
  "battery_voltage": 3.2,      âœ… å¾ cloudData.pub.msg.data æå‡
  "rssi": -52,                  âœ… å¾ cloudData.pub.msg.data æå‡
  "heart_rate": 72,             âœ… å¾ cloudData.pub.msg.data æå‡
  "temperature": 36.5,          âœ… å¾ cloudData.pub.msg.data æå‡
  "fw_update": false,           âœ… å¾ cloudData.fw_update (0â†’false) è½‰æ›
  "led_enabled": true,          âœ… å¾ cloudData.led (1â†’true) è½‰æ›ï¼Œé‡å‘½å
  "ble_enabled": true,          âœ… å¾ cloudData.ble (1â†’true) è½‰æ›ï¼Œé‡å‘½å
  "is_initiator": false,        âœ… å¾ cloudData.initiator (0â†’false) è½‰æ›ï¼Œé‡å‘½å

  // ä¸­ç¹¼æ•¸æ“š
  "timestamp": "2025-11-17T14:30:00Z",
  "processing_timestamp": "2025-11-19T00:49:50.146613Z"
}
```

### æ•¸æ“šè½‰æ›è·¯å¾‘

| åŸå§‹å­—æ®µ | å±¤ç´š | è½‰æ›å¾Œå­—æ®µ | è½‰æ›é¡å‹ | å€¼ä¿ç•™ |
|---------|------|----------|---------|--------|
| anchor_id | 1 | device_id | é‡å‘½å | âœ… |
| name | 1 | device_name | é‡å‘½å | âœ… |
| gateway_id | 1 | gateway_id | ç›´æ¥ | âœ… |
| mac_address | 1 | mac_address | ç›´æ¥ | âœ… |
| position.x | 2 | position_x | æ‰å¹³åŒ– | âœ… |
| position.y | 2 | position_y | æ‰å¹³åŒ– | âœ… |
| position.z | 2 | position_z | æ‰å¹³åŒ– | âœ… |
| status | 1 | status | ç›´æ¥ | âœ… |
| lastSeen | 1 | last_seen | é‡å‘½å | âœ… |
| isBound | 1 | is_bound | é‡å‘½å | âœ… |
| cloudData.pub.msg.data.battery_voltage | 5 | battery_voltage | ç›´æ¥æå‡ | âœ… |
| cloudData.pub.msg.data.rssi | 5 | rssi | ç›´æ¥æå‡ | âœ… |
| cloudData.pub.msg.data.heart_rate | 5 | heart_rate | ç›´æ¥æå‡ | âœ… |
| cloudData.pub.msg.data.temperature | 5 | temperature | ç›´æ¥æå‡ | âœ… |
| cloudData.fw_update | 2 | fw_update | å¸ƒæ—è½‰æ› (0â†’false) | âœ… |
| cloudData.led | 2 | led_enabled | å¸ƒæ—è½‰æ› + é‡å‘½å (1â†’true) | âœ… |
| cloudData.ble | 2 | ble_enabled | å¸ƒæ—è½‰æ› + é‡å‘½å (1â†’true) | âœ… |
| cloudData.initiator | 2 | is_initiator | å¸ƒæ—è½‰æ› + é‡å‘½å (0â†’false) | âœ… |

---

## ğŸ¯ é—œéµé©—è­‰é»

### âœ… 1. å±¤ç´šè½‰æ›ç¢ºå¯¦ç™¼ç”Ÿ

**åŸå§‹ï¼š** 4 å±¤åµŒå¥—çµæ§‹
```
åŸå§‹ JSON
â”œâ”€ ç¬¬1å±¤ï¼šanchor_id, gateway_id, name, position{...}, cloudData{...}
â”‚  â”œâ”€ ç¬¬2å±¤ï¼šposition{x, y, z}
â”‚  â””â”€ ç¬¬2å±¤ï¼šcloudData{id, pub{...}, fw_update, led, ...}
â”‚     â”œâ”€ ç¬¬3å±¤ï¼špub{msg{...}}
â”‚     â”‚  â””â”€ ç¬¬4å±¤ï¼šmsg{data{...}}
â”‚     â”‚     â””â”€ ç¬¬5å±¤ï¼šdata{battery_voltage, rssi, ...}
```

**è½‰æ›å¾Œï¼š** 1 å±¤å¹³é¢çµæ§‹ï¼ˆçœŸæ­£çš„ 2 å±¤æ‰å¹³åŒ–ï¼‰
```
æ‰å¹³åŒ– JSON
â”œâ”€ device_id
â”œâ”€ device_name
â”œâ”€ battery_voltage        â† å¾ç¬¬5å±¤æå‡
â”œâ”€ rssi                    â† å¾ç¬¬5å±¤æå‡
â”œâ”€ fw_update              â† å¾ç¬¬2å±¤æå‡
â”œâ”€ led_enabled            â† å¾ç¬¬2å±¤æå‡
â””â”€ ... æ‰€æœ‰å­—æ®µéƒ½åœ¨ç¬¬1å±¤
```

### âœ… 2. æ²’æœ‰æ•¸æ“šè¢«åˆªé™¤

**åŸå§‹è‘‰å­ç¯€é»ï¼š** 23 å€‹  
**æ‰å¹³åŒ–å¾Œå­—æ®µï¼š** 21 å€‹ï¼ˆå…¶ä¸­ 18 å€‹æ˜¯åŸå§‹æ•¸æ“š + 3 å€‹æ˜¯å¢åŠ çš„ä¸­ç¹¼å­—æ®µï¼‰

**è¨ˆç®—ï¼š**
- åŸå§‹ 23 å€‹è‘‰å­ç¯€é» â†’ è½‰æ›ç‚º 18 å€‹å­—æ®µ âœ…
- æ–°å¢ 3 å€‹ä¸­ç¹¼å­—æ®µï¼šdevice_type, timestamp, processing_timestamp
- ç¸½è¨ˆï¼š18 + 3 = 21 å­—æ®µ âœ…

### âœ… 3. å¸ƒæ—å€¼è¢«æ­£ç¢ºè½‰æ›

| åŸå§‹ | è½‰æ›å‰ | è½‰æ›å¾Œ | èªªæ˜ |
|------|-------|-------|------|
| fw_update | 0 | false | âœ… æ•´æ•¸è½‰å¸ƒæ— |
| led | 1 | true (led_enabled) | âœ… æ•´æ•¸è½‰å¸ƒæ— + é‡å‘½å |
| ble | 1 | true (ble_enabled) | âœ… æ•´æ•¸è½‰å¸ƒæ— + é‡å‘½å |
| initiator | 0 | false (is_initiator) | âœ… æ•´æ•¸è½‰å¸ƒæ— + é‡å‘½å |

### âœ… 4. åµŒå¥—çµæ§‹è¢«å®Œæ•´æ‰å¹³åŒ–

| åŸå§‹åµŒå¥— | è½‰æ›æ–¹å¼ | æ‰å¹³åŒ–å¾Œ |
|---------|---------|---------|
| position{x, y, z} | åˆ†è§£ | position_x, position_y, position_z |
| cloudData.pub.msg.data.* | ç›´æ¥æå‡ | battery_voltage, rssi, ... |

---

## ğŸ“ˆ Gateway æ¸¬è©¦çµæœ

### Gateway 1 (Living Room)

**åŸå§‹ 4 å±¤çµæ§‹ â†’ è½‰æ›å¾Œ 16 å­—æ®µ**

```json
// åŸå§‹ 4 å±¤
{
  "gateway_id": "gw_001",                    // ç¬¬1å±¤
  "cloudData": {                             // ç¬¬1å±¤
    "pub": {                                 // ç¬¬2å±¤
      "msg": {                               // ç¬¬3å±¤
        "data": {                            // ç¬¬4å±¤
          "battery_voltage": 3.7,            // ç¬¬5å±¤
          "rssi": -45                        // ç¬¬5å±¤
        }
      }
    },
    "fw_version": "v2.1.0"                   // ç¬¬2å±¤
  }
}

// æ‰å¹³åŒ–å¾Œ 1 å±¤ (16 å­—æ®µ)
{
  "device_id": "gw_001",
  "device_type": "gateway",
  "device_name": "Living Room",
  "ip_address": "192.168.1.100",
  "mac_address": "00:1A:2B:3C:4D:5E",
  "position_x": 10.5,
  "position_y": 20.3,
  "position_z": 1.2,
  "status": "online",
  "last_seen": "2025-11-17T14:30:00Z",
  "battery_voltage": 3.7,      âœ… å¾ç¬¬5å±¤æå‡
  "rssi": -45,                  âœ… å¾ç¬¬5å±¤æå‡
  "fw_version": "v2.1.0",       âœ… å¾ç¬¬2å±¤æå‡
  "is_bound": false,
  "timestamp": "2025-11-17T14:30:00Z",
  "processing_timestamp": "2025-11-19T00:49:50.147026Z"
}
```

---

## ğŸ”¬ è½‰æ›é‚è¼¯é©—è­‰

### ä½ç½®ä¿¡æ¯æå‡

**åŸå§‹ï¼š** åµŒå¥—åœ¨ 2 å±¤æ·±
```python
position = {
  "x": 5.2,
  "y": 8.1,
  "z": 0.8
}
```

**è½‰æ›ï¼š** å®Œå…¨æ‰å¹³åŒ–
```python
position_x = 5.2  âœ…
position_y = 8.1  âœ…
position_z = 0.8  âœ…
```

### æ·±å±¤æ•¸æ“šæå‡

**åŸå§‹ï¼š** æ·±åŸ‹åœ¨ 5 å±¤
```python
cloudData = {
  "pub": {
    "msg": {
      "data": {
        "battery_voltage": 3.2,
        "rssi": -52
      }
    }
  }
}
```

**è½‰æ›ï¼š** ç›´æ¥æå‡åˆ°ç¬¬ 1 å±¤
```python
battery_voltage = 3.2  âœ…
rssi = -52             âœ…
```

---

## âœ¨ çµè«–

### æ˜¯å¦çœŸçš„æ‰å¹³åŒ–äº†ï¼Ÿ âœ… **æ˜¯çš„**

1. **å±¤ç´šç¢ºå¯¦è¢«ç¸®æ¸›**
   - å¾ 4-5 å±¤åµŒå¥— â†’ 1 å±¤å¹³é¢çµæ§‹
   - æ‰€æœ‰æ•¸æ“šéƒ½åœ¨å­—å…¸çš„ç›´æ¥éµå€¼å°ä¸­

2. **æ²’æœ‰åˆªé™¤ä»»ä½•æ•¸æ“š**
   - åŸå§‹ 23 å€‹è‘‰å­ç¯€é» â†’ è½‰æ›å¾Œ 18 å€‹å­—æ®µ
   - åŠ ä¸Š 3 å€‹æ–°å¢ä¸­ç¹¼å­—æ®µ â†’ ç¸½è¨ˆ 21 å€‹å­—æ®µ
   - 100% æ•¸æ“šä¿ç•™ç‡

3. **åªé€²è¡Œäº†çµæ§‹é‡çµ„**
   - åµŒå¥—çµæ§‹è¢«æ‰“å¹³
   - å­—æ®µè¢«é‡å‘½åï¼ˆä¾‹ï¼šanchor_id â†’ device_idï¼‰
   - é¡å‹è¢«è½‰æ›ï¼ˆä¾‹ï¼š0/1 â†’ false/trueï¼‰
   - ä½†å€¼å®Œå…¨ä¿ç•™

4. **è½‰æ›æ˜¯å¯é€†çš„**
   - å¦‚æœéœ€è¦ï¼Œå¯ä»¥å¾æ‰å¹³åŒ–çµæ§‹é‡å»ºåŸå§‹åµŒå¥—çµæ§‹
   - æ‰€æœ‰å¿…è¦çš„ä¿¡æ¯éƒ½è¢«ä¿ç•™

### Pipeline çš„è¨­è¨ˆæ­£ç¢ºæ€§ âœ… **ç¢ºèª**

Pipeline çš„æ‰å¹³åŒ–è¨­è¨ˆï¼š
- âœ… å®Œæ•´ä¿ç•™åŸå§‹æ•¸æ“š
- âœ… ç§»é™¤ä¸å¿…è¦çš„åµŒå¥—
- âœ… ä½¿æ•¸æ“šæ›´å®¹æ˜“æŸ¥è©¢å’Œåˆ†æ
- âœ… æ›´é©åˆå­˜å„²åœ¨ BigQuery å’Œ Redis ä¸­

---

## ğŸš€ ä½¿ç”¨å»ºè­°

### ä½•æ™‚ä½¿ç”¨æ‰å¹³åŒ–æ•¸æ“š

âœ… **é©åˆä½¿ç”¨æ‰å¹³åŒ– 2 å±¤çµæ§‹**
- å­˜å„²åˆ° BigQueryï¼ˆåˆ†ææŸ¥è©¢ï¼‰
- å­˜å„²åˆ° Redisï¼ˆå³æ™‚è®€å–ï¼‰
- API è¿”å›çµ¦å‰ç«¯
- æ•¸æ“šå ±è¡¨ç”Ÿæˆ

âŒ **ä¸é©åˆä½¿ç”¨**
- éœ€è¦ä¿å­˜åŸå§‹ MQTT æ ¼å¼æ™‚
- éœ€è¦è¿½è¸ªå®Œæ•´åµŒå¥—å±¤ç´šæ™‚

### è‹¥è¦ä¿å­˜åŸå§‹æ ¼å¼

```python
# åŒæ™‚ä¿å­˜åŸå§‹æ ¼å¼å’Œæ‰å¹³åŒ–æ ¼å¼
{
  "original": {...},          # åŸå§‹ 4 å±¤çµæ§‹
  "flattened": {...}          # æ‰å¹³åŒ– 2 å±¤çµæ§‹
}
```

---

**æ¸¬è©¦å®Œæˆæ™‚é–“ï¼š** 2025-11-19  
**çµæœï¼š** âœ… æ‰€æœ‰é©—è­‰é€šé  
**çµè«–ï¼š** Pipeline æ­£ç¢ºåœ°æ‰å¹³åŒ–äº† 4 å±¤çµæ§‹ï¼Œæœªåˆªé™¤ä»»ä½•æ•¸æ“š


