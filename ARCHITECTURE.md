# ğŸ—ï¸ SeniorCarePlusDataFlow æ¶æ§‹è¨­è¨ˆ

## ğŸ“– ç›®éŒ„
- [æ¦‚è¿°](#æ¦‚è¿°)
- [æ•¸æ“šæµè½‰æ›](#æ•¸æ“šæµè½‰æ›)
- [ç³»çµ±æ¶æ§‹](#ç³»çµ±æ¶æ§‹)
- [æ¨¡å¡Šè¨­è¨ˆ](#æ¨¡å¡Šè¨­è¨ˆ)
- [Pipeline æµç¨‹](#pipeline-æµç¨‹)
- [é›†æˆæ–¹æ¡ˆ](#é›†æˆæ–¹æ¡ˆ)
- [æ€§èƒ½è€ƒé‡](#æ€§èƒ½è€ƒé‡)

---

## æ¦‚è¿°

SeniorCarePlusDataFlow æ˜¯ä¸€å€‹ **Apache Beam æ•¸æ“šè™•ç† Pipeline**ï¼Œç”¨æ–¼å°‡è¤‡é›œçš„å¤šå±¤ IoT æ•¸æ“šè½‰æ›ç‚ºæ‰å¹³çš„çµæ§‹ï¼Œä¾¿æ–¼åˆ†æå’Œå¯¦æ™‚è™•ç†ã€‚

```
åŸå§‹æ•¸æ“š (4å±¤)           æ‰å¹³åŒ–æ•¸æ“š (2å±¤)           ç›®æ¨™å­˜å„²
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   cloudData      â”‚     â”‚ Device Info      â”‚    â”‚BigQuery â”‚
â”‚   â”œâ”€â”€ pub        â”‚  â†’ â”‚ (ç¬¬1å±¤)          â”‚ â†’  â”‚Redis    â”‚
â”‚   â”‚  â”œâ”€â”€ msg     â”‚     â”‚ â”œâ”€â”€ device_id    â”‚    â”‚GCS      â”‚
â”‚   â”‚  â”‚  â””â”€â”€ data â”‚     â”‚ â”œâ”€â”€ status       â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚   â”‚  â”‚     â”œâ”€â”€.. â”‚     â”‚ â””â”€â”€ ...          â”‚
â”‚   â”œâ”€â”€ config  ..â”‚     â”‚ Sensor Data      â”‚
â”‚   â””â”€â”€ fw_ver  ..â”‚     â”‚ (ç¬¬2å±¤)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”œâ”€â”€ battery      â”‚
                         â”‚ â”œâ”€â”€ rssi         â”‚
                         â”‚ â”œâ”€â”€ heart_rate   â”‚
                         â”‚ â””â”€â”€ temperature  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•¸æ“šæµè½‰æ›

### Gateway 4å±¤ â†’ 2å±¤ è½‰æ›

#### åŸå§‹çµæ§‹ï¼ˆ4å±¤ï¼‰

```json
{
  "gateway_id": "gw_001",
  "name": "Living Room",
  "ip_address": "192.168.1.100",
  "cloudData": {
    "id": 1,
    "pub": {
      "msg": {
        "data": {
          "battery_voltage": 3.7,
          "rssi": -45
        }
      }
    },
    "fw_version": "v2.1.0"
  },
  "position": {"x": 10.5, "y": 20.3, "z": 1.2}
}
```

#### æ‰å¹³åŒ–çµæ§‹ï¼ˆ2å±¤ï¼‰

```json
{
  "device_id": "gw_001",
  "device_type": "gateway",
  "device_name": "Living Room",
  "ip_address": "192.168.1.100",
  "position_x": 10.5,
  "position_y": 20.3,
  "position_z": 1.2,
  "status": "online",
  "battery_voltage": 3.7,
  "rssi": -45,
  "fw_version": "v2.1.0",
  "signal_level": "good",
  "timestamp": "2025-11-17T14:30:00Z"
}
```

### Anchor 4å±¤ â†’ 2å±¤ è½‰æ›

#### åŸå§‹çµæ§‹ï¼ˆ4å±¤ï¼‰

```json
{
  "anchor_id": "anchor_001",
  "gateway_id": "gw_001",
  "cloudData": {
    "id": 1,
    "pub": {
      "msg": {
        "data": {
          "battery_voltage": 3.2,
          "rssi": -52,
          "heart_rate": 72,
          "temperature": 36.5
        }
      }
    },
    "fw_update": 0,
    "led": 1,
    "ble": 1,
    "initiator": 0
  }
}
```

#### æ‰å¹³åŒ–çµæ§‹ï¼ˆ2å±¤ï¼‰

```json
{
  "device_id": "anchor_001",
  "device_type": "anchor",
  "gateway_id": "gw_001",
  "battery_voltage": 3.2,
  "rssi": -52,
  "heart_rate": 72,
  "temperature": 36.5,
  "fw_update": false,
  "led_enabled": true,
  "ble_enabled": true,
  "is_initiator": false,
  "battery_level": "medium",
  "signal_level": "fair",
  "timestamp": "2025-11-17T14:30:00Z"
}
```

---

## ç³»çµ±æ¶æ§‹

### å®Œæ•´æ•¸æ“šæµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     IoT è¨­å‚™                                 â”‚
â”‚            (Gateway + Anchor MQTT æ¶ˆæ¯)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Cloud Pub/Sub       â”‚
        â”‚  (æ¶ˆæ¯éšŠåˆ—)           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Apache Beam DirectRunner    â”‚
        â”‚  (é–‹ç™¼/æ¸¬è©¦ç’°å¢ƒ)              â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  æˆ–                         â”‚
        â”‚  Apache Beam DataflowRunner â”‚
        â”‚  (ç”Ÿç”¢ç’°å¢ƒ - GCP)           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Pipeline è™•ç†éšæ®µ                    â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ 1. é©—è­‰ (Validation)                 â”‚
        â”‚    â”œâ”€â”€ å¿…è¦å­—æ®µæª¢æŸ¥                   â”‚
        â”‚    â”œâ”€â”€ æ•¸æ“šé¡å‹é©—è­‰                   â”‚
        â”‚    â””â”€â”€ å€¼åŸŸç¯„åœæª¢æŸ¥                   â”‚
        â”‚                                     â”‚
        â”‚ 2. æ‰å¹³åŒ– (Flattening)              â”‚
        â”‚    â”œâ”€â”€ 4å±¤â†’2å±¤è½‰æ›                  â”‚
        â”‚    â”œâ”€â”€ å­—æ®µæå–                      â”‚
        â”‚    â””â”€â”€ åµŒå¥—çµæ§‹å±•é–‹                  â”‚
        â”‚                                     â”‚
        â”‚ 3. å¢å¼· (Enrichment)                â”‚
        â”‚    â”œâ”€â”€ è¨ˆç®—å­—æ®µ (signal_level)      â”‚
        â”‚    â”œâ”€â”€ ç‹€æ…‹æ¨å° (battery_level)     â”‚
        â”‚    â””â”€â”€ æ™‚æˆ³æ·»åŠ                       â”‚
        â”‚                                     â”‚
        â”‚ 4. åˆ†é¡ (Classification)            â”‚
        â”‚    â”œâ”€â”€ æœ‰æ•ˆæ•¸æ“š                      â”‚
        â”‚    â””â”€â”€ ç„¡æ•ˆæ•¸æ“š (éŒ¯èª¤æ—¥èªŒ)           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                       â–¼             â–¼          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚BigQueryâ”‚          â”‚  Redis   â”‚   â”‚  GCS  â”‚   â”‚ éŒ¯èª¤æ—¥èªŒâ”‚
    â”‚(å†·æ•¸æ“š)â”‚          â”‚(ç†±æ•¸æ“š)   â”‚   â”‚(å‚™ä»½)  â”‚   â”‚ (ç›£æ§) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å¡Šä¾è³´é—œä¿‚

```
models/
â”œâ”€â”€ gateway_data.py          FlattenedGatewayData
â”‚   â””â”€â”€ ç”¨æ–¼: transforms/flatten_transform.py
â”‚
â””â”€â”€ anchor_data.py           FlattenedAnchorData
    â””â”€â”€ ç”¨æ–¼: transforms/flatten_transform.py

transforms/
â”œâ”€â”€ flatten_transform.py
â”‚   â”œâ”€â”€ FlattenGatewayTransform      (DoFn)
â”‚   â”œâ”€â”€ FlattenAnchorTransform       (DoFn)
â”‚   â””â”€â”€ EnrichDataTransform          (DoFn)
â”‚
â””â”€â”€ validation_transform.py
    â”œâ”€â”€ ValidateGatewayTransform     (DoFn)
    â”œâ”€â”€ ValidateAnchorTransform      (DoFn)
    â””â”€â”€ FilterValidRecordsTransform  (DoFn)

pipelines/
â”œâ”€â”€ gateway_flattening.py
â”‚   â””â”€â”€ GatewayFlatteningPipeline
â”‚       â”œâ”€â”€ ReadFromText/Pub/Sub
â”‚       â”œâ”€â”€ ParDo(ValidateGatewayTransform)
â”‚       â”œâ”€â”€ ParDo(FlattenGatewayTransform)
â”‚       â”œâ”€â”€ ParDo(EnrichDataTransform)
â”‚       â””â”€â”€ WriteToBigQuery/Text
â”‚
â””â”€â”€ anchor_flattening.py
    â””â”€â”€ AnchorFlatteningPipeline
        â”œâ”€â”€ ReadFromText/Pub/Sub
        â”œâ”€â”€ ParDo(ValidateAnchorTransform)
        â”œâ”€â”€ ParDo(FlattenAnchorTransform)
        â”œâ”€â”€ ParDo(EnrichDataTransform)
        â””â”€â”€ WriteToBigQuery/Text

config/
â””â”€â”€ pipeline_config.py
    â””â”€â”€ Config (ç”¨æ–¼æ‰€æœ‰ Pipeline)

utils/
â”œâ”€â”€ logger.py               (JSON æ—¥èªŒ)
â”œâ”€â”€ helpers.py              (è¼”åŠ©å‡½æ•¸)
â””â”€â”€ ç”¨æ–¼æ‰€æœ‰æ¨¡å¡Š
```

---

## æ¨¡å¡Šè¨­è¨ˆ

### 1. Models æ¨¡å¡Š (`src/models/`)

**ç›®çš„**ï¼šå®šç¾©åŸå§‹å’Œæ‰å¹³åŒ–çš„æ•¸æ“šçµæ§‹

#### GatewayDataï¼ˆåŸå§‹çµæ§‹ï¼‰
```python
@dataclass
class GatewayData:
    gateway_id: str
    name: str
    ip_address: Optional[str]
    mac_address: Optional[str]
    cloud_data: Optional[Dict]    # 4å±¤åµŒå¥—
    position: Optional[Dict]
    status: str
    last_seen: Optional[str]
```

#### FlattenedGatewayDataï¼ˆæ‰å¹³çµæ§‹ï¼‰
```python
@dataclass
class FlattenedGatewayData:
    # ç¬¬1å±¤ï¼šè¨­å‚™ä¿¡æ¯
    device_id: str
    device_type: str = "gateway"
    position_x: Optional[float]
    position_y: Optional[float]
    position_z: Optional[float]
    
    # ç¬¬2å±¤ï¼šå‚³æ„Ÿå™¨æ•¸æ“š
    battery_voltage: Optional[float]
    rssi: Optional[int]
    fw_version: Optional[str]
    signal_level: Optional[str]
    
    # ä¸­ç¹¼æ•¸æ“š
    timestamp: Optional[str]
    processing_timestamp: Optional[str]
```

### 2. Transforms æ¨¡å¡Š (`src/transforms/`)

**ç›®çš„**ï¼šå¯¦ç¾ Apache Beam çš„ DoFn è½‰æ›é‚è¼¯

#### FlattenGatewayTransform
```python
class FlattenGatewayTransform(beam.DoFn):
    def process(self, element: Dict[str, Any]):
        # 1. è§£æè¼¸å…¥ JSON
        # 2. å»ºç«‹ GatewayData å°è±¡
        # 3. æ·±å±¤æå– cloudData.pub.msg.data
        # 4. è½‰æ›ç‚º FlattenedGatewayData
        # 5. è¼¸å‡ºç‚ºå­—å…¸
        yield flattened.to_dict()
```

### 3. Pipelines æ¨¡å¡Š (`src/pipelines/`)

**ç›®çš„**ï¼šå®šç¾©å®Œæ•´çš„ Beam Pipeline

#### GatewayFlatteningPipeline
```
è®€å– (Read)
    â†“
é©—è­‰ (Validate)
    â†“
æ‰å¹³åŒ– (Flatten)
    â†“
å¢å¼· (Enrich)
    â†“
åˆ†é¡ (Partition)
    â”œâ”€â†’ æœ‰æ•ˆ â†’ BigQuery
    â””â”€â†’ ç„¡æ•ˆ â†’ éŒ¯èª¤æ—¥èªŒ
```

### 4. Config æ¨¡å¡Š (`src/config/`)

**ç›®çš„**ï¼šç®¡ç†ç’°å¢ƒé…ç½®

```python
class Config:
    project_id: str                # GCP é …ç›®
    region: str                    # GCP å€åŸŸ
    gcs_temp_bucket: str          # è‡¨æ™‚å­˜å„²
    bigquery_dataset: str         # BigQuery æ•¸æ“šé›†
    gateway_table: str            # Gateway è¡¨
    batch_size: int               # æ‰¹è™•ç†å¤§å°
    max_num_workers: int          # æœ€å¤§ worker æ•¸
```

---

## Pipeline æµç¨‹

### åŸ·è¡Œæ­¥é©Ÿ

```
Step 1: åˆå§‹åŒ–
  â”œâ”€ è®€å–é…ç½® (config/dev.yaml æˆ– config/prod.yaml)
  â”œâ”€ å»ºç«‹ Pipeline Options
  â””â”€ è¨­ç½® Runner (DirectRunner æˆ– DataflowRunner)

Step 2: æ•¸æ“šè¼¸å…¥
  â”œâ”€ File mode: è®€å–æœ¬åœ° JSON æ–‡ä»¶
  â””â”€ Pub/Sub mode: é€£æ¥ Cloud Pub/Sub ä¸»é¡Œ

Step 3: é©—è­‰
  â”œâ”€ æª¢æŸ¥å¿…è¦å­—æ®µå­˜åœ¨
  â”œâ”€ é©—è­‰æ•¸æ“šé¡å‹ (int, float, string, ...)
  â”œâ”€ æª¢æŸ¥å€¼åŸŸç¯„åœ (RSSI: -200 < x < 0, ...)
  â””â”€ ç”Ÿæˆ is_valid æ¨™è¨˜

Step 4: æ‰å¹³åŒ–
  â”œâ”€ æ·±å±¤éæ­·åµŒå¥—çµæ§‹ (cloudData.pub.msg.data)
  â”œâ”€ æå–æ‰€æœ‰è‘‰ç¯€é»æ•¸æ“š
  â”œâ”€ æ˜ å°„åˆ°ç¬¬2å±¤çµæ§‹
  â””â”€ è½‰æ›å¸ƒçˆ¾å€¼ (0/1 â†’ true/false)

Step 5: å¢å¼·
  â”œâ”€ è¨ˆç®— signal_level (åŸºæ–¼ RSSI)
  â”œâ”€ è¨ˆç®— battery_level (åŸºæ–¼é›»å£“)
  â”œâ”€ æ·»åŠ è™•ç†æ™‚æˆ³
  â””â”€ æ·»åŠ å…¶ä»–è¨ˆç®—å­—æ®µ

Step 6: åˆ†é¡
  â”œâ”€ æ ¹æ“š is_valid åˆ†æ”¯
  â”œâ”€ æœ‰æ•ˆæ•¸æ“š â†’ å¤šé‡è¼¸å‡º
  â””â”€ ç„¡æ•ˆæ•¸æ“š â†’ éŒ¯èª¤æ—¥èªŒ

Step 7: è¼¸å‡º
  â”œâ”€ BigQuery: ç”¨æ–¼åˆ†æ
  â”œâ”€ Redis: ç”¨æ–¼å¯¦æ™‚æŸ¥è©¢ï¼ˆé€šéå¾Œç«¯ï¼‰
  â”œâ”€ GCS: ç”¨æ–¼å‚™ä»½
  â””â”€ Text: ç”¨æ–¼é–‹ç™¼æ¸¬è©¦

Step 8: å®Œæˆ
  â”œâ”€ ç›£æ§ Pipeline ç‹€æ…‹
  â”œâ”€ è¨˜éŒ„æ€§èƒ½æŒ‡æ¨™
  â””â”€ ç”ŸæˆåŸ·è¡Œå ±å‘Š
```

---

## é›†æˆæ–¹æ¡ˆ

### èˆ‡å¾Œç«¯é›†æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Senior Care Plus Backend                  â”‚
â”‚            (SeniorCarePlusBackend)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  Pub/Sub Source (Cloud Pub/Sub)                   â”‚
â”‚       â†‘                                             â”‚
â”‚       â”‚ (MQTT æ¶ˆæ¯)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  Message Topics                    â”‚            â”‚
â”‚  â”‚  â”œâ”€â”€ gateway-events               â”‚            â”‚
â”‚  â”‚  â””â”€â”€ anchor-events                â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚       â”‚                                             â”‚
â”‚       â”‚ (JSON æ¶ˆæ¯)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Ktor Routes                                   â”‚â”‚
â”‚  â”‚  â”œâ”€â”€ /api/gateways   (POST/PUT/GET)          â”‚â”‚
â”‚  â”‚  â”œâ”€â”€ /api/anchors    (POST/PUT/GET)          â”‚â”‚
â”‚  â”‚  â””â”€â”€ /api/analytics  (GET reports)           â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚       â”‚                                            â”‚
â”‚       â”‚ (æŸ¥è©¢çµæœ)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   PostgreSQL        â”‚  â”‚ Redis Cache      â”‚   â”‚
â”‚  â”‚   (æ¥­å‹™æ•¸æ“š)         â”‚  â”‚ (ç†±æ•¸æ“š)         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Cloud Dataflow       â”‚
         â”‚  (æ•¸æ“šè½‰æ›)            â”‚
         â”‚  SeniorCarePlusDataFlow
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚ - é©—è­‰    â”‚ - æ‰å¹³åŒ–  â”‚
         â”‚ - å¢å¼·    â”‚ - åˆ†é¡    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚BigQueryâ”‚           â”‚  Redis   â”‚
    â”‚(å†·æ•¸æ“š)â”‚           â”‚(ç†±æ•¸æ“š)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶ˆæ¯æ ¼å¼

#### Pub/Sub æ¶ˆæ¯ï¼ˆåŸå§‹ 4å±¤ï¼‰
```json
{
  "type": "gateway",
  "data": {
    "gateway_id": "gw_001",
    "cloudData": {
      "pub": {
        "msg": {
          "data": {
            "battery_voltage": 3.7
          }
        }
      }
    }
  }
}
```

#### Pipeline è¼¸å‡ºï¼ˆæ‰å¹³ 2å±¤ï¼‰
```json
{
  "device_id": "gw_001",
  "device_type": "gateway",
  "battery_voltage": 3.7,
  "timestamp": "2025-11-17T14:30:00Z"
}
```

---

## æ€§èƒ½è€ƒé‡

### ååé‡ä¼°è¨ˆ

```
é–‹ç™¼ç’°å¢ƒ (DirectRunner):
  - å–®ç·šç¨‹è™•ç†
  - ååé‡ï¼š~1-10 MB/s
  - é©åˆï¼šæ¸¬è©¦ã€å°è¦æ¨¡æ•¸æ“š

ç”Ÿç”¢ç’°å¢ƒ (DataflowRunner):
  - è‡ªå‹•æ“´å±• worker
  - ååé‡ï¼š~100-1000 MB/s
  - æˆæœ¬ï¼šæŒ‰ vCPU.å°æ™‚ è¨ˆè²»

æ•¸æ“šé‡ï¼š
  - Gateway äº‹ä»¶ï¼š< 10 KB/æ¢
  - Anchor äº‹ä»¶ï¼š< 5 KB/æ¢
  - é æœŸååï¼š100-1000 æ¢/ç§’
  - æ—¥æ•¸æ“šé‡ï¼š~5-50 GB
```

### å„ªåŒ–å»ºè­°

```
1. æ‰¹è™•ç†å¤§å°
   â”œâ”€ é–‹ç™¼ï¼šbatch_size = 1000
   â””â”€ ç”Ÿç”¢ï¼šbatch_size = 10000

2. Worker é…ç½®
   â”œâ”€ é–‹ç™¼ï¼šmax_workers = 2-5
   â””â”€ ç”Ÿç”¢ï¼šmax_workers = 10-20

3. çª—å£åŒ–èšåˆ
   â”œâ”€ å›ºå®šçª—å£ï¼š5 åˆ†é˜
   â””â”€ æ»‘å‹•çª—å£ï¼šç”¨æ–¼è¶¨å‹¢åˆ†æ

4. ç·©å­˜ç­–ç•¥
   â”œâ”€ æ¨¡å‹å­—å…¸åœ¨è¨˜æ†¶é«”ä¸­
   â””â”€ å¤–éƒ¨æŸ¥è©¢ï¼ˆRedisï¼‰åšç·©å­˜
```

---

## ç›£æ§å’Œæ—¥èªŒ

### æ—¥èªŒæ ¼å¼ï¼ˆJSONï¼‰

```json
{
  "timestamp": "2025-11-17T14:30:00Z",
  "level": "INFO",
  "logger": "dataflow",
  "message": "Processing Gateway gw_001",
  "input_size_bytes": 512,
  "processing_time_ms": 45,
  "status": "success"
}
```

### ç›£æ§æŒ‡æ¨™

```
Pipeline Level:
  â”œâ”€ ç¸½è¼¸å…¥è¨˜éŒ„æ•¸
  â”œâ”€ æˆåŠŸ/å¤±æ•—/ç„¡æ•ˆè¨˜éŒ„æ•¸
  â”œâ”€ å¹³å‡è™•ç†æ™‚é–“
  â”œâ”€ ååé‡ (è¨˜éŒ„/ç§’)
  â””â”€ è³‡æºä½¿ç”¨ (CPU, è¨˜æ†¶é«”)

Stage Level:
  â”œâ”€ é©—è­‰éšæ®µé€šéç‡
  â”œâ”€ æ‰å¹³åŒ–æˆåŠŸç‡
  â”œâ”€ å¢å¼·éšæ®µè€—æ™‚
  â””â”€ åˆ†é¡å¾Œçš„åˆ†å¸ƒ

Output Level:
  â”œâ”€ BigQuery å¯«å…¥æˆåŠŸç‡
  â”œâ”€ Redis ç·©å­˜å‘½ä¸­ç‡
  â”œâ”€ GCS å‚™ä»½å®Œæˆæƒ…æ³
  â””â”€ éŒ¯èª¤æ—¥èªŒè¨˜éŒ„æ•¸
```

---

## éƒ¨ç½²æ¶æ§‹

### æœ¬åœ°é–‹ç™¼

```bash
python -m src.main \
  --runner DirectRunner \
  --input-type file \
  --input-file test_data/gateways.json
```

### GCP éƒ¨ç½²

```bash
python -m src.main \
  --runner DataflowRunner \
  --project senior-care-plus-prod \
  --region asia-east1 \
  --input-type pubsub \
  --input-topic projects/xxx/topics/gateway-events
```

---

## é—œéµç‰¹æ€§

âœ… **é«˜åº¦é€šç”¨**ï¼šæ”¯æŒä»»æ„å±¤ç´šçš„åµŒå¥—çµæ§‹  
âœ… **å®¹éŒ¯èƒ½åŠ›**ï¼šè©³ç´°çš„æ•¸æ“šé©—è­‰å’ŒéŒ¯èª¤è¨˜éŒ„  
âœ… **å¯æ“´å±•**ï¼šæ˜“æ–¼æ·»åŠ æ–°çš„è½‰æ›é‚è¼¯  
âœ… **å¤šç’°å¢ƒ**ï¼šæ”¯æŒæœ¬åœ°ã€é–‹ç™¼ã€æ¸¬è©¦ã€ç”Ÿç”¢  
âœ… **å¯¦æ™‚ç›£æ§**ï¼šå®Œæ•´çš„æ—¥èªŒå’ŒæŒ‡æ¨™  
âœ… **æˆæœ¬å„ªåŒ–**ï¼šæŒ‰éœ€ä»˜è²»ï¼Œè‡ªå‹•æ“´å±•  

---

æ›´æ–°æ™‚é–“ï¼š2025-11-17  
ç‰ˆæœ¬ï¼š1.0.0




